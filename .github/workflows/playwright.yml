name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  # Cron job to run every day at 6 AM IST (00:30 UTC)
  schedule:
    - cron: '30 0 * * *'

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install dependencies
        run: npm install

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # -------------------------------
      # TEST EXECUTION
      # -------------------------------
      - name: Run Playwright tests
        id: test-run
        run: npm run conduit-sanity

      # -------------------------------
      # RESULT PARSING
      # -------------------------------
      #- name: Install jq
      #  run: sudo apt-get update && sudo apt-get install -y jq

      - name: Parse test results
        id: test-stats
        if: always()
        run: |
          REPORT_FILE="test-results/jsonReport.json"

          TOTAL=$(jq '.stats.expected + .stats.unexpected + .stats.flaky + .stats.skipped' $REPORT_FILE)
          PASSED=$(jq '.stats.expected + .stats.flaky' $REPORT_FILE)
          FAILED=$(jq '.stats.unexpected' $REPORT_FILE)
          SKIPPED=$(jq '.stats.skipped' $REPORT_FILE)

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

      # -------------------------------
      # ARTIFACTS
      # -------------------------------
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: test-results
          path: test-results/
          retention-days: 30

      # -------------------------------
      # EMAIL NOTIFICATION
      # -------------------------------
      - name: Send email report
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: princepandey155@gmail.com
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: 'Playwright Test Report for ${{ github.repository }}: ${{ job.status }}'
          to: princepandey155@gmail.com
          from: GitHub Actions CI <notifications@example.com>
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
            <title>Playwright Test Execution Report</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
              .container { max-width: 600px; margin: 20px auto; background-color: #ffffff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
              .header { background-color: #24292e; color: #ffffff; padding: 20px; text-align: center; border-top-left-radius: 8px; border-top-right-radius: 8px; }
              .header h1 { margin: 0; }
              .content { padding: 20px; }
              .footer { padding: 10px; font-size: 0.8em; text-align: center; color: #777; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; background-color: #f6f8fa; }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; }
              th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
              th { background-color: #f6f8fa; font-weight: bold; }
              a { color: #0366d6; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .metrics-table th { width: 120px; }
            </style>
            </head>
            <body>
            <div class="container">
              <div class="header">
                <h1>Playwright Test Report</h1>
              </div>
              <div class="content">
                <h2>Job Status:
                  <span style="font-weight: bold; text-transform: uppercase; color: ${{ job.status == 'success' && '#28a745' || '#dc3545' }};">
                    ${{ job.status }}
                  </span>
                </h2>

                <h3>Test Execution Summary</h3>
                <table class="metrics-table">
                  <tr>
                    <th>Total Tests</th>
                    <td>${{ steps.test-stats.outputs.total }}</td>
                  </tr>
                  <tr>
                    <th style="color: #28a745;">Passed</th>
                    <td style="color: #28a745; font-weight: bold;">${{ steps.test-stats.outputs.passed }}</td>
                  </tr>
                  <tr>
                    <th style="color: #dc3545;">Failed</th>
                    <td style="color: #dc3545; font-weight: bold;">${{ steps.test-stats.outputs.failed }}</td>
                  </tr>
                  <tr>
                    <th style="color: #6a737d;">Skipped</th>
                    <td style="color: #6a737d; font-weight: bold;">${{ steps.test-stats.outputs.skipped }}</td>
                  </tr>
                </table>

                <p>A test run has completed in your repository. Here is a summary:</p>
                <table>
                  <tr>
                    <th>Repository</th>
                    <td><a href="${{ github.server_url }}/${{ github.repository }}">${{ github.repository }}</a></td>
                  </tr>
                  <tr>
                    <th>Branch</th>
                    <td><code>${{ github.ref_name }}</code></td>
                  </tr>
                  <tr>
                    <th>Commit</th>
                    <td><a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}">${{ github.sha }}</a></td>
                  </tr>
                  <tr>
                    <th>Triggered by</th>
                    <td>${{ github.actor }}</td>
                  </tr>
                  <tr>
                    <th>Workflow Run</th>
                    <td><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Workflow Run</a></td>
                  </tr>
                </table>
                <p style="text-align:center; margin-top: 25px;">The full test report is available as a downloadable artifact in the workflow run page.</p>
              </div>
              <div class="footer">
                <p>This is an automated notification from the GitHub Actions CI/CD pipeline.</p>
              </div>
            </div>
            </body>
            </html>